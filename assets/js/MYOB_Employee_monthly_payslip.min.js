/*! MYOB_Employee_monthly_payslip 05-07-2016 */
app.controller("indexCtrl",["$scope","$http","$interval","$routeParams","$location","$rootScope","$timeout","promiseTracker","$alert","$q","Upload","$window",function($scope,$http,$interval,$routeParams,$location,$rootScope,$timeout,promiseTracker,$alert,$q,Upload,$window){function beginCount(){var promise=$timeout(function(){$scope.showSpinner=!1,console.log("validating.."),$scope.fname&&$scope.lname&&$scope.annualSalary&&parseInt($scope.superRate)<=50&&parseInt($scope.superRate)>=0?($scope.fullname=$scope.fname+" "+$scope.lname,$scope.endDate=moment($scope.startDate).add(28,"day").format("DD MMMM"),$scope.payPeriod=moment($scope.startDate).format("DD MMMM")+" - "+$scope.endDate,$scope.grossIncome=Math.round(parseInt($scope.annualSalary)/12).toLocaleString(),countIncomeTax(parseInt($scope.annualSalary)).then(function(d){$scope.incomeTax=Math.round(d).toLocaleString(),$scope.netIncome=(Math.round(parseInt($scope.annualSalary)/12)-Math.round(d)).toLocaleString(),$scope.super=Math.round(Math.round(parseInt($scope.annualSalary)/12)*parseInt($scope.superRate)/100).toLocaleString(),insertTable()})):errorAlert.show()},2e3);$scope.loadingTracker.addPromise(promise)}function countIncomeTax(annualSa){var defer=$q.defer();if(annualSa<=18200)var data=0;else if(annualSa>18200&&annualSa<=37e3)var data=.19*(annualSa-18200)/12;else if(annualSa>37e3&&annualSa<=8e4)var data=(3572+.325*(annualSa-37e3))/12;else if(annualSa>8e4&&annualSa<=18e4)var data=(17547+.37*(annualSa-8e4))/12;else var data=(54547+.45*(annualSa-18e4))/12;return defer.resolve(data),defer.promise}function insertTable(){var oneRow={name:$scope.fullname,payPeriod:$scope.payPeriod,grossIncome:$scope.grossIncome,incomeTax:$scope.incomeTax,netIncome:$scope.netIncome,super:$scope.super};$scope.finalJsonArray.push(oneRow),$scope.createCSVfile()}$scope.showSpinner=!1,$scope.loadingTracker=promiseTracker(),$scope.finalJsonArray=[],$scope.disableDownload=!0;var errorAlert=$alert({title:"Error!",content:"Please Enter all fields. Salary should be positive integer. Super should less than or equal to 50%. Pay period should be one month",placement:"top",type:"danger",show:!1,duration:10});$scope.calculate=function(){console.log("waiting 2 seconds.."),errorAlert.hide(),$scope.showSpinner=!0,beginCount()},$scope.createCSVfile=function(){$scope.disableDownload=!1;var finalString=JSON.stringify($scope.finalJsonArray);console.log("json string is ",finalString),$http.post("/createCSV?finalJsonArray="+finalString).success(function(data){console.log(data),$scope.downloadURL="/"+data})}}]);